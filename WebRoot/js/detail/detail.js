require(["tip"],function(a){function b(){function b(){$.ajax({url:"/item/item_detail",type:"post",dataType:"json",data:{itemId:itemInfo.id},success:function(a){"SUCCESS"==a.status?c(a):(n.html(a.msg).removeClass(),l())},error:function(a){n.html("获取商品信息失败，请稍后再试。("+a.status+")").removeClass(),l()}})}function c(a){function b(a,b){for(var c="no",d=0;d<b.length;d++){var e=b[d][0];if(e==a){c=b[d][1];break}}return c}var c=a.skus,h=s_i=sold=storage=0,k=c.length,m=c[k-1];if(1==k&&"无"==c[0].color&&"无"==c[0].specification)a.price=c[0].price,a.nowPrice=c[0].nowPrice,sold=c[0].salesVolume,storage=c[0].storage,o.nono=c[0];else{for(var r=0;k>r;r++){var t=c[r].picUrl,u=c[r].color,w=c[r].specification,x="";if(sold+=c[r].salesVolume,storage+=c[r].storage,"无"!=u){var y=b(u,p);"no"==y?(h++,x="c"+h,p.push([u,"c"+h,t]),s[x]=t):x=y}else x="no";if("无"!=w){var z=b(w,q);"no"==z?(s_i++,x=x+"s"+s_i,q.push([w,"s"+s_i])):x+=z}else x+="no";o[x]=c[r]}1==k||!a.isPromo&&c[0].price==m.price||a.isPromo&&c[0].nowPrice==m.nowPrice?(a.price=c[0].price,a.nowPrice=c[0].nowPrice):(a.price=c[0].price+" - "+m.price,a.nowPrice=c[0].nowPrice+" - "+m.nowPrice)}a.skucode=c[0].code,a.sold=sold,a.storage=storage,a.color=p,a.spec=q,a.isPromo?(a.maxIntegral=parseInt(m.nowPrice),itemInfo.atype=a.isPromo.type):(itemInfo.atype="NORMAL",a.maxIntegral=parseInt(m.price)),itemInfo.storage=a.storage,itemInfo.maxIntegral=a.maxIntegral,itemInfo.price=a.price,itemInfo.nowPrice=a.nowPrice,require(["tpl/shop/ajax_skuinfo"],function(b){var c=b(a);n.html(c).removeClass(),v=$("#buy_btn"),f(),d(),a.isPromo&&e(a.isPromo),g(),i(),l(),j()})}function d(){function b(b){var c='<div class="addcart_ok"><div class="tip"><i class="iconfont">&#xe648;</i>商品已成功加入购物车</div><div class="go"><a href="javascript:;" id="dialog_close" class="back">&lt;&lt;继续购物</a><a href="/cart/" class="btn">去购物车结算</a></div></div>',d=a.dialog({id:"addcart_ok",skin:"dialog_addcart_ok",fixed:!0,padding:0,title:"加入购物车成功",content:c,onshow:function(){$("#dialog_close").click(function(){d.close().remove()})}});d.show()}function c(a,b){var c=1,d=setInterval(function(){c%2?a.addClass("warn_color"):a.removeClass("warn_color"),c++,7==c&&(clearInterval(d),b&&b())},150)}var d=$("#s_num").find("input"),e=$("#s_storage"),f=$("#color_list"),g=$("#spec_list");v.on("click",function(){var h=$(this),i=$.trim(d.val());return 1==h.data("clicked")||h.hasClass("offbtn")?!1:(h.data("clicked",1),"no"==r&&f.length>0?(c(f),h.data("clicked",0),!1):"no"==S_code&&g.length>0?(c(g),h.data("clicked",0),!1):(LIZI.check.isInt(i)||(d.val("1"),i=1),i=parseInt(i),1>i&&(i=1),i>parseInt(e.text())?(a.warn("购买数量超过库存或限购数！"),d.val("1"),h.data("clicked",0),!1):o[r+S_code].storage<1?(a.warn(void 0!=o.nono?"此商品已缺货！":"此规格的商品已缺货，换个规格购买吧。"),h.data("clicked",0),!1):(h.html('<img src="http://s.lizi.com/www/images/loading.gif" /> 加入购物车'),void $.ajax({url:"/cart/add",type:"post",data:{storeId:itemInfo.storeId,skuId:o[r+S_code].id,itemCount:i,atype:itemInfo.atype},dataType:"json",success:function(c){if("SUCCESS"==c.status){var d=LIZI.userInfo.cartNum;b(),d++,$("#header_cart").data("loaded","no").data("cartIsNull","no").find(".cartnum").html(d)}else a.warn(c.msg);h.data("clicked",0).html('<i class="iconfont">&#365;</i>加入购物车')},error:function(b){h.data("clicked",0).html('<i class="iconfont">&#365;</i>加入购物车'),a.warn("服务器忙，请稍后再试。("+b.status+")")}}))))})}function e(a){require(["timedown"],function(b){var c=!1;"60秒抢"==a.name&&(c=!0),b({elem:$("#timedown"),endTime:a.time,onlySec:c,endFunc:function(){v.html("商品已失效").addClass("offbtn")}})})}function f(){function a(){var a=null,b=$("#s_price"),c=$("#s_integral"),d=$("#s_storage"),e=0,f=!1;"no"===r&&"no"===S_code||"no"===r&&p.length>0||"no"===S_code&&q.length>0?(f=!0,a=itemInfo):a=o[r+S_code],b.html(a.price),f?(e=a.maxIntegral,a.nowPrice&&$("#s_nowprice").html(a.nowPrice)):a.nowPrice?($("#s_nowprice").html(a.nowPrice),e=parseInt(a.nowPrice)):e=parseInt(a.price),c.html('可获<em class="red">'+e+"</em>积分（抵￥"+(e/100).toFixed(2)+"）"),d.data("limit")||d.html(a.storage)}function b(a){var b=null;b=1==a?g:h,null!=b&&b.removeClass("disabled").each(function(){var b=$(this),c=b.data("code");_temp="",_temp=1==a?c+S_code:r+c,o[_temp]?o[_temp].storage<1&&b.addClass("disabled"):b.addClass("disabled")})}function c(a){var b=s[a];b+="!wh400",u.attr("src",b)}function d(){var a=itemInfo.cover+"!wh400";u.attr("src",a)}var e=$("#color_list"),f=$("#spec_list"),g=null,h=null;e.length>0&&(g=e.find("a"),1==g.length?(g.addClass("current"),r="c1"):g.on("click",function(){var e=$(this);return e.hasClass("disabled")?!1:(e.hasClass("current")?(e.removeClass("current"),null!=h&&h.removeClass("disabled"),r="no",d()):(r=e.data("code"),b(2),g.removeClass("current"),e.addClass("current"),c(r)),a(),!1)})),f.length>0&&(h=f.find("a"),1==h.length?(h.addClass("current"),S_code="s1"):h.on("click",function(){var c=$(this);return c.hasClass("disabled")?!1:(c.hasClass("current")?(c.removeClass("current"),null!=g&&g.removeClass("disabled"),S_code="no"):(S_code=c.data("code"),b(1),h.removeClass("current"),c.addClass("current")),a(),!1)}))}function g(){var a=null,b=$("#s_storage");$("#s_num").on("click","span.num_op",function(){var c=$(this),d=c.siblings("input"),e=num=0;if(c.hasClass("disabled"))return!1;if(clearTimeout(a),num=d.val(),e=parseInt(b.text()),!(1>e)){if(!LIZI.check.isInt(num))return d.val(1),!1;num=parseInt(num),c.hasClass("add")?num++:num--,num>=e?(c.addClass("disabled"),num=e):num<=1&&(num=1,c.addClass("disabled")),c.siblings("span").removeClass("disabled"),d.val(num)}}).on("keyup","input",function(){var c=$(this),d=val=0;clearTimeout(a),d=parseInt(b.text()),val=c.val(),a=""==val||0==val?setTimeout(function(){c.val(1).focus()},1e3):setTimeout(function(){LIZI.check.isInt(val)?(val=parseInt(val),val>=d?(val=d,c.val(val).siblings("span").removeClass("disabled").eq(1).addClass("disabled")):1==val?c.siblings("span").removeClass("disabled").eq(0).addClass("disabled"):c.siblings("span").removeClass("disabled"),c.val(val).trigger("blur")):c.val(1).focus()},500)}).on("paste","input",function(){return!1})}function h(){var a=t.find(".view_thumbs"),b=a.find("img").eq(0).clone(),c=a.find("li").length,d=null;b.insertAfter(u),a.find("li").append('<i class="iconfont arrow">&#x194;</i>'),c>5&&(c=5),a.find("ul").css({width:64*c}),a.on("mouseenter","li",function(){var a=$(this);return a.hasClass("current")?!1:void(d=setTimeout(function(){var c=(a.index(),a.find("img")),d=c.attr("src"),e=d.replace("!wh70","!wh400");a.addClass("current").siblings("li").removeClass("current"),b.attr("src",d),u.attr("src",e)},200))}).on("mouseleave","li",function(){null!=d&&clearTimeout(d)})}function i(){var b=itemInfo.id,c=$("#fav_btn");c.click(function(){return c.hasClass("offbtn")?!1:LIZI.userInfo.login?1==c.data("clicked")?!1:(c.data("clicked",1),void $.ajax({url:"json.html",type:"post",dataType:"json",data:{itemId:b},success:function(b){1==b.status?c.addClass("offbtn").html('<i class="iconfont">&#x169;</i>已收藏'):a.warn("收藏失败，请稍后再试。"),c.data("clicked",0)},error:function(b){a.warn("服务器忙，请稍后再试。("+b.status+")"),c.data("clicked",0)}})):(require(["popup/login"],function(a){a()}),!1)})}function j(){$("#ewm_img").on("mouseenter",function(){$(this).find(".ewm_img_box").show()}).on("mouseleave",function(){$(this).find(".ewm_img_box").hide()})}function k(){var a=$("#seemore_items"),b=a.find("a.refresh"),c=a.find("ul");require(["tpl/shop/seemore"],function(a){function d(){$.ajax({url:"/item/item_seemore",type:"post",data:{itemId:itemInfo.id,page:e},dataType:"json",success:function(b){"SUCCESS"==b.status?(e++,c.html(a(b))):c.html(b.msg)},error:function(a){c.html("服务器忙，请稍后再试。("+a.status+")")}})}var e=0;d(),b.click(function(){d()})})}function l(){var a=$("#tabs_bar"),b=a.offset().top,c=$("div.sectionbox");require(["scrollfixed"],function(b){b(a)}),$("#s_comment").click(function(){return a.find("li").eq(1).trigger("click"),!1}),a.on("click","li",function(){var a=$(this),d=a.find("a").attr("href");return a.addClass("current").siblings().removeClass("current"),"#part_detail"==d?c.show():(c.hide(),$(d).show()),window.scrollTo(0,b),!1})}function m(){function b(a){$("#tabs_bar").find("li").eq(1).trigger("click"),c.html('<div class="load" style="padding:110px 0 60px; text-align:center;">正在努力加载评价内容</div>'),$.ajax({url:"/item/commentList",type:"post",dataType:"json",data:a,success:function(a){"SUCCESS"==a.status?require(["tpl/shop/comment"],function(b){var d="";a.comments.length>0?(null!==h&&(d=h(a.pages.current,a.pages.total)),c.html(b(a)+d)):c.html('<div class="error">暂无此商品评价。</div>')}):c.html('<div class="error">商品评价数据加载失败，请稍后再试。</div>')},error:function(a){c.html('<div class="error">商品评价数据加载失败，请稍后再试。('+a.status+")</div>")}})}var c=$("#comment_list"),d=$("#comment_sort"),e=d.find("select")[0],f=d.find("select[name=order]"),g=$("#cmt_point_list"),h=null,i="";i=e.name,g.find("li").each(function(){var a=$(this),b=a.data("point");a.find("span").css("width",100*b/5+"%")}),require(["view_photos"],function(a){a(c)}),itemInfo.commentPage>1&&require(["pagenav"],function(a){var b="";h=a,b=h(1,itemInfo.commentPage),c.append(b)}),setTimeout(function(){var a=LIZI.userInfo.userType;("STORE"==a||"SUBSTORE"==a)&&$("#part_comment").find(".d_right").find("a.btn").hide()},500),c.on("click","a.useful_btn",function(){var b=$(this);return _id="",LIZI.userInfo.login?(require(["popup/login"],function(a){a()}),!1):b.hasClass("clicked")?!1:(_id=b.data("id"),void $.ajax({url:"json.html",dataType:"json",type:"post",data:{commentId:_id},success:function(c){"SUCCESS"==c.status?(b.addClass("clicked"),b.find("em").html(parseInt(b.find("em").text())+1)):a.warn(c.msg)},error:function(b){a.warn("服务器忙，请稍后再试。("+b.status+")")}}))}).on("click","a.step",function(){var a={};a.id=itemInfo.id,("skin"==i||"hair"==i)&&(a[i]=e.value),a.order=f.val(),a.page=$(this).data("page"),b(a)}),d.find("select").change(function(){var a={};a.id=itemInfo.id,("skin"==i||"hair"==i)&&(a[i]=e.value),a.order=f.val(),a.page=1,b(a)})}var n=$("#item_info"),o={},p=[],q=[],r=S_code="no",s={},t=$("#item_cover"),u=t.find("img.view"),v=null;this.init=function(){b(),h(),k(),m()}}(new b).init()});